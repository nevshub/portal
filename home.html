<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Welcome to the Home Page</h1>

  <!-- Admin Streaming Section -->
  <div id="streamSection">
    <h2>Admin Streaming</h2>
    <button id="startStreamBtn" class="button">Start Stream</button>
    <button id="popoutStreamBtn" class="button">Pop-out Stream</button>
    <video id="liveStream" autoplay playsinline></video>
    
    <h3>Stream History</h3>
    <ul id="streamList"></ul>
  </div>

  <script>
    const ADMIN_PASSWORD = "Nev123";
    let role = localStorage.getItem("userRole") || "guest";

    // Prompt for Admin password if not set
    if(role !== "member") {
      const input = prompt("Enter Admin password (leave empty if guest):");
      if(input === ADMIN_PASSWORD) role = "admin";
      else if(input) role = "member";
      else role = "guest";
      localStorage.setItem("userRole", role);
    }

    const streamSection = document.getElementById("streamSection");
    const startStreamBtn = document.getElementById("startStreamBtn");
    const popoutStreamBtn = document.getElementById("popoutStreamBtn");
    const liveStream = document.getElementById("liveStream");
    const streamListEl = document.getElementById("streamList");

    let localStream = null;
    let popoutWindow = null;
    let streams = JSON.parse(localStorage.getItem("streams") || "[]");

    // Only show for admin
    if(role !== "admin") streamSection.style.display = "none";
    if(role === "admin") {
      streamSection.style.display = "block";
      renderStreamList();
    }

    async function startStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        liveStream.srcObject = localStream;

        // Save stream entry in history
        const name = prompt("Enter a name for this stream:", "New Stream") || "New Stream";
        const timestamp = new Date().toLocaleString();
        const streamEntry = { id: Date.now(), name, timestamp };
        streams.unshift(streamEntry); // newest first
        localStorage.setItem("streams", JSON.stringify(streams));
        renderStreamList();
      } catch(err) {
        alert("Cannot access camera/microphone: " + err);
      }
    }

    function popoutStream() {
      if(!localStream) {
        alert("Start the stream first.");
        return;
      }

      if(popoutWindow && !popoutWindow.closed) {
        popoutWindow.focus();
        return;
      }

      popoutWindow = window.open("", "PopoutStream", "width=800,height=600");
      popoutWindow.document.write(`
        <html>
        <head>
          <title>Live Stream</title>
          <style>
            body { margin:0; background:#111; display:flex; justify-content:center; align-items:center; height:100vh; }
            video { width:100%; height:auto; max-width:780px; border-radius:8px; }
          </style>
        </head>
        <body>
          <video id="popoutVideo" autoplay playsinline></video>
        </body>
        </html>
      `);

      const popoutVideo = popoutWindow.document.getElementById("popoutVideo");
      popoutVideo.srcObject = localStream;
    }

    startStreamBtn.addEventListener("click", startStream);
    popoutStreamBtn.addEventListener("click", popoutStream);

    function renderStreamList() {
      streamListEl.innerHTML = "";
      streams.forEach(stream => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>Name:</strong> <span class="streamName">${stream.name}</span> 
          | <strong>Time:</strong> ${stream.timestamp} 
          <button class="editBtn">Edit</button>
          <button class="deleteBtn">Delete</button>
        `;

        li.querySelector(".editBtn").addEventListener("click", () => {
          const newName = prompt("Edit stream name:", stream.name);
          if(newName) {
            stream.name = newName;
            localStorage.setItem("streams", JSON.stringify(streams));
            renderStreamList();
          }
        });

        li.querySelector(".deleteBtn").addEventListener("click", () => {
          if(confirm("Delete this stream?")) {
            streams = streams.filter(s => s.id !== stream.id);
            localStorage.setItem("streams", JSON.stringify(streams));
            renderStreamList();
          }
        });

        streamListEl.appendChild(li);
      });
    }
  </script>
</body>
</html>
