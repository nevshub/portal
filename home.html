<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Welcome to the Home Page</h1>

  <!-- Admin Streaming Section -->
  <div id="streamSection" style="margin-top:30px; display:none;">
    <h2>Admin Streaming</h2>
    <button id="startStreamBtn" class="button">Start Stream</button>
    <button id="popoutStreamBtn" class="button">Popout Stream</button>
    <video id="liveStream" autoplay playsinline style="width:100%; max-width:700px; margin-top:20px; border-radius:8px;"></video>
    
    <h3>Stream History</h3>
    <ul id="streamList" style="list-style:none; padding:0;"></ul>
  </div>

  <!-- Guest View Section -->
  <div id="viewerSection" style="margin-top:30px; display:none;">
    <h2>Live Stream</h2>
    <video id="viewerStream" autoplay playsinline style="width:100%; max-width:700px; margin-top:20px; border-radius:8px;"></video>
  </div>

  <script>
    const ADMIN_PASSWORD = "Nev123";
    let role = localStorage.getItem("userRole") || "guest";

    // Prompt for Admin password if not set
    if(role !== "member") {
      const input = prompt("Enter Admin password (leave empty if guest):");
      if(input === ADMIN_PASSWORD) role = "admin";
      else if(input) role = "member";
      else role = "guest";
      localStorage.setItem("userRole", role);
    }

    const streamSection = document.getElementById("streamSection");
    const viewerSection = document.getElementById("viewerSection");
    const startStreamBtn = document.getElementById("startStreamBtn");
    const popoutStreamBtn = document.getElementById("popoutStreamBtn");
    const liveStream = document.getElementById("liveStream");
    const viewerStream = document.getElementById("viewerStream");
    const streamListEl = document.getElementById("streamList");

    if(role === "admin") streamSection.style.display = "block";
    else if(role === "guest" || role === "member") viewerSection.style.display = "block";

    let localStream = null;
    let peers = {};
    const socket = new WebSocket("ws://localhost:3000"); // signaling server
    let streams = JSON.parse(localStorage.getItem("streams") || "[]");

    // Render saved streams
    function renderStreamList() {
      streamListEl.innerHTML = "";
      streams.forEach(stream => {
        const li = document.createElement("li");
        li.style.marginBottom = "10px";
        li.innerHTML = `
          <strong>Name:</strong> <span class="streamName">${stream.name}</span> 
          | <strong>Time:</strong> ${stream.timestamp} 
          <button class="editBtn" style="margin-left:10px;">Edit</button>
          <button class="deleteBtn" style="margin-left:5px;">Delete</button>
        `;
        li.querySelector(".editBtn").onclick = () => {
          const newName = prompt("Edit stream name:", stream.name);
          if(newName) { stream.name = newName; localStorage.setItem("streams", JSON.stringify(streams)); renderStreamList(); }
        };
        li.querySelector(".deleteBtn").onclick = () => {
          if(confirm("Delete this stream?")) { streams = streams.filter(s => s.id !== stream.id); localStorage.setItem("streams", JSON.stringify(streams)); renderStreamList(); }
        };
        streamListEl.appendChild(li);
      });
    }

    if(role === "admin") renderStreamList();

    // WebSocket signaling
    socket.onmessage = async (event) => {
      const data = JSON.parse(event.data);

      if(data.type === "offer" && role !== "admin") {
        const pc = new RTCPeerConnection();
        peers[data.id] = pc;
        pc.ontrack = e => viewerStream.srcObject = e.streams[0];

        await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);

        socket.send(JSON.stringify({ type: "answer", answer, id: data.id }));
      }

      if(data.type === "answer" && role === "admin") {
        const pc = peers[data.id];
        if(pc) await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
      }

      if(data.type === "candidate") {
        const pc = peers[data.id];
        if(pc) pc.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    };

    async function startStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
        liveStream.srcObject = localStream;

        // Save stream entry in history
        const name = prompt("Enter stream name:", "New Stream") || "New Stream";
        const timestamp = new Date().toLocaleString();
        const streamEntry = { id: Date.now(), name, timestamp };
        streams.unshift(streamEntry);
        localStorage.setItem("streams", JSON.stringify(streams));
        renderStreamList();

        broadcastToViewers();
      } catch(err) {
        alert("Cannot access camera/microphone: " + err);
      }
    }

    async function broadcastToViewers() {
      const viewerId = Date.now();
      const pc = new RTCPeerConnection();
      peers[viewerId] = pc;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      pc.onicecandidate = e => { if(e.candidate) socket.send(JSON.stringify({ type:"candidate", candidate:e.candidate, id:viewerId })); };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.send(JSON.stringify({ type:"offer", offer, id:viewerId }));
    }

    startStreamBtn.addEventListener("click", startStream);

    popoutStreamBtn.addEventListener("click", () => {
      if(!localStream) { alert("Start the stream first."); return; }
      const win = window.open("", "Popout", "width=800,height=600");
      const video = win.document.createElement("video");
      video.autoplay = true;
      video.playsInline = true;
      video.srcObject = localStream;
      video.style.width = "100%";
      video.style.height = "auto";
      win.document.body.appendChild(video);
    });
  </script>
</body>
</html>
